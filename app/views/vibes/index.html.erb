<div class="vibe-stream">
  <% @vibes.each do |vibe| %>
    <div class="vibe-item">
      <div class="vibe-video-container">
        <!-- Video -->
        <video autoplay loop muted playsinline class="vibe-video" data-vibe-id="<%= vibe.id %>">
          <source src="<%= url_for(vibe.video) %>" type="video/mp4">
          Tarayıcınız bu videoyu desteklemiyor.
        </video>

        <!-- Ses durumu göstergesi -->
        <div class="video-sound-indicator">
          <i class="fas fa-volume-mute"></i>
        </div>

        <!-- Sağ taraf etkileşim butonları -->
        <div class="vibe-actions">
          <div class="action-item">
            <%= render "like_button", vibe: vibe %>
            <%= render "like_count", vibe: vibe %>
          </div>

          <div class="action-item">
            <%= link_to vibe_path(vibe), class: "action-button" do %>
              <i class="far fa-comment"></i>
              <span class="action-count"><%= vibe.comments.count %></span>
            <% end %>
          </div>

          <div class="action-item">
            <button class="action-button">
              <i class="far fa-share-square"></i>
            </button>
          </div>
        </div>

        <!-- Alt bilgi alanı -->
        <div class="vibe-info">
          <div class="user-info">
            <div class="user-avatar">
              <% if vibe.user.avatar.present? %>
                <%= image_tag vibe.user.avatar_url %>
              <% else %>
                <i class="fas fa-user"></i>
              <% end %>
            </div>
            <span class="username">@<%= vibe.user.username %></span>
          </div>
          <p class="caption"><%= vibe.caption %></p>
        </div>
      </div>
    </div>
  <% end %>
</div>

<style>
    /* Vibe akış container'ı */
    .vibe-stream {
        display: flex;
        flex-direction: column;
        overflow-y: scroll;
        height: 100vh; /* Tam ekran yüksekliği */
        scroll-snap-type: y mandatory; /* Kaydırma türü */
    }

    /* Her vibe öğesi */
    .vibe-item {
        height: 100vh; /* Her öğe tam ekran yüksekliğinde olacak */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        scroll-snap-align: start; /* Her öğe hizalanacak */
        position: relative;
    }

    /* Video ayarları */
    .vibe-video {
        height: 88vh; /* Yükseklik ekranın %88'i */
        max-width: 100%; /* Genişlik, ekran genişliğini geçmeyecek */
        object-fit: cover; /* Video, alanı dolduracak şekilde ayarlanacak */
        border-radius: 10px; /* Yuvarlak köşeler (isteğe bağlı) */
        box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.3); /* Hafif gölge (isteğe bağlı) */
    }

    /* Video açıklaması */
    .vibe-caption {
        position: absolute;
        bottom: 20px;
        left: 20px;
        color: white;
        text-shadow: 1px 1px 5px rgba(0, 0, 0, 0.8);
        background-color: rgba(0, 0, 0, 0.5);
        padding: 10px 15px;
        border-radius: 8px;
    }

    .video-sound-indicator {
        position: absolute;
        bottom: 20px;
        right: 20px;
        color: white;
        background: rgba(0, 0, 0, 0.5);
        padding: 8px;
        border-radius: 50%;
        cursor: pointer;
        z-index: 20;
        transition: all 0.2s ease;
    }

    .video-sound-indicator:hover {
        transform: scale(1.1);
        background: rgba(0, 0, 0, 0.7);
    }
</style>


<script>
    document.addEventListener("DOMContentLoaded", () => {
        const videos = document.querySelectorAll(".vibe-video");
        let currentPlayingVideo = null;
        let isSoundEnabled = false;

        // Intersection Observer Ayarları
        const observerOptions = {
            root: null,
            threshold: 0.75,
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach((entry) => {
                const video = entry.target;
                if (entry.isIntersecting) {
                    if (currentPlayingVideo && currentPlayingVideo !== video) {
                        currentPlayingVideo.pause();
                    }
                    currentPlayingVideo = video;
                    video.muted = !isSoundEnabled;
                    updateSoundIcon(video, !isSoundEnabled);
                    video.play().catch(console.error);
                } else {
                    video.pause();
                }
            });
        }, observerOptions);

        function updateSoundIcon(video, isMuted) {
            const container = video.closest('.vibe-video-container');
            const soundIndicator = container.querySelector('.video-sound-indicator');
            const icon = soundIndicator.querySelector('i');
            
            if (isMuted) {
                icon.className = 'fas fa-volume-mute';
            } else {
                icon.className = 'fas fa-volume-up';
            }
        }

        // Tüm videoları gözlemle
        videos.forEach((video) => {
            observer.observe(video);
            const container = video.closest('.vibe-video-container');
            const soundIndicator = container.querySelector('.video-sound-indicator');
            
            // Video tıklama olayını ekle
            video.addEventListener("click", () => {
                if (video.paused) {
                    video.play();
                } else {
                    video.pause();
                }
            });

            // Ses göstergesi tıklama olayı
            soundIndicator.addEventListener("click", () => {
                if (video === currentPlayingVideo) {
                    isSoundEnabled = !isSoundEnabled;
                    video.muted = !isSoundEnabled;
                    updateSoundIcon(video, !isSoundEnabled);
                }
            });
        });
    });
</script>